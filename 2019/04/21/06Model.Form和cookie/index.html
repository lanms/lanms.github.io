<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Django-Form和ModelForm-Cookie-Session | Lanms Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="widget = forms.HiddenInput()   # 表单小组件, 隐藏字段 initial = {}  添加表单初始数据   # 41 行 调用 is_valid 时, 写的额外的验证时也会执行 redirect(&apos;url&apos;)   重定向, 重新加载  Form 和 ModelForm 第 16 行 和 第 45 行相同 ModelForm   exclude=()  排除字段 he">
<meta name="keywords" content="django">
<meta property="og:type" content="article">
<meta property="og:title" content="Django-Form和ModelForm-Cookie-Session">
<meta property="og:url" content="http://yoursite.com/2019/04/21/06Model.Form和cookie/index.html">
<meta property="og:site_name" content="Lanms Blog">
<meta property="og:description" content="widget = forms.HiddenInput()   # 表单小组件, 隐藏字段 initial = {}  添加表单初始数据   # 41 行 调用 is_valid 时, 写的额外的验证时也会执行 redirect(&apos;url&apos;)   重定向, 重新加载  Form 和 ModelForm 第 16 行 和 第 45 行相同 ModelForm   exclude=()  排除字段 he">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2019/04/21/06Model.Form和cookie/assert/post.png">
<meta property="og:image" content="http://yoursite.com/2019/04/21/06Model.Form和cookie/HTTP请求.png">
<meta property="og:image" content="http://yoursite.com/2019/04/21/06Model.Form和cookie/cookie.png">
<meta property="og:image" content="http://yoursite.com/2019/04/21/06Model.Form和cookie/清理数据.png">
<meta property="og:updated_time" content="2019-04-21T01:52:26.832Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Django-Form和ModelForm-Cookie-Session">
<meta name="twitter:description" content="widget = forms.HiddenInput()   # 表单小组件, 隐藏字段 initial = {}  添加表单初始数据   # 41 行 调用 is_valid 时, 写的额外的验证时也会执行 redirect(&apos;url&apos;)   重定向, 重新加载  Form 和 ModelForm 第 16 行 和 第 45 行相同 ModelForm   exclude=()  排除字段 he">
<meta name="twitter:image" content="http://yoursite.com/2019/04/21/06Model.Form和cookie/assert/post.png">
  
    <link rel="alternate" href="/atom.xml" title="Lanms Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  <link rel="stylesheet" href="/css/tocas.css">
  <link rel="stylesheet" href="/css/animate.css">
  <link rel="stylesheet" href="/css/style.css">
  <style type="text/css">
    a.title-link:hover{
        color: #34b2db !important;
    }

    a.title-link:active{
        color: #2075c1 !important;
    }

    #menu-color-id{
        background : #f7f7f7;
    }

    #menu-color-id a{
        color: #5a5a5a;
    }
  </style>
  <script src="/js/tocas.js"></script>
  

<link rel="stylesheet" href="/css/prism.css" type="text/css"></head></html>

<body>
<!-- navigation -->

<div class="ts fluid basic link big menu" id="menu-color-id">

    <!-- ejs : align to post page or index page -->
        
            <div class="ts very narrow container">
        

        
            <a class="item" href="/">Home</a>
        
            <a class="item" href="/archives">Archives</a>
        
    </div>
</div>
<!-- the end of navigation -->

<!-- big bang title -->
<div class="ts padded horizontally fitted fluid slate" style="background-color: #f7f7f7;">
    <!-- ejs : align to post page or index page -->
    
        <div class="ts very narrow container">
    
        <!-- Title -->
        <h1 class="ts eleven wide column header be-center-h1">
            <span style="color: #404040;" id="big-title">Lanms Blog</span>
            <div class="sub header" id="slogan-bar" style=" margin-top: 15px; color: #404040;"></div>
        </h1>
        <!-- the end of title -->
    </div>
</div>
<!-- the end of big bang title -->
</body>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">

<!-- main section -->
<div class="ts text container">
        <!-- left section -->
        <div class="column" style=" padding: 35px; ">
            <!-- Articles -->
                
                <h1 class="ts header">
                    <span style="color: #333;">Django-Form和ModelForm-Cookie-Session</span>
                    <div class="sub header" style="color: #808080;">Publish: 2019/3/21 
                     &nbsp;&nbsp;
                        <ul class="unstyled radius-tag -list"><li class="unstyled radius-tag -list-item"><a class="unstyled radius-tag -list-link" href="/tags/django/">django</a></li></ul>
                    
                    </div>
                </h1>

                <pre class=" language-python"><code class="language-python">widget <span class="token operator">=</span> forms<span class="token punctuation">.</span>HiddenInput<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true"># 表单小组件, 隐藏字段</span>
initial <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  添加表单初始数据   <span class="token comment" spellcheck="true"># 41 行</span>
调用 is_valid 时<span class="token punctuation">,</span> 写的额外的验证时也会执行
redirect<span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span>   重定向<span class="token punctuation">,</span> 重新加载
</code></pre>
<h4 id="Form-和-ModelForm"><a href="#Form-和-ModelForm" class="headerlink" title="Form 和 ModelForm"></a>Form 和 ModelForm</h4><ul>
<li>第 16 行 和 第 45 行相同</li>
<li>ModelForm  <ul>
<li>exclude=()  排除字段</li>
<li>help_text=’’  放在 <code>&lt;span&gt;</code>中</li>
</ul>
</li>
</ul>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># Form</span>
<span class="token keyword">class</span> <span class="token class-name">CarRecordForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>

    carno <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">7</span> <span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'车牌号'</span><span class="token punctuation">,</span>
                            error_messages<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    case <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'违章原因'</span><span class="token punctuation">)</span>
    punish <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> 
                             label<span class="token operator">=</span><span class="token string">'处罚方式'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#required 属性False可以不填</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        f <span class="token operator">=</span> CarRecordForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> CarRecordForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
        <span class="token keyword">if</span> f<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            a <span class="token operator">=</span> f<span class="token punctuation">.</span>cleaned_data <span class="token comment" spellcheck="true"># 获得输入的纯数据, 字典样式</span>
            Car<span class="token punctuation">(</span><span class="token operator">**</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
            f <span class="token operator">=</span> CarRecordForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            errors <span class="token operator">=</span> f<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 所有的错误信息</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'add.html'</span><span class="token punctuation">,</span>
                  context<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'f'</span><span class="token punctuation">:</span> f<span class="token punctuation">,</span> <span class="token string">'errors'</span><span class="token punctuation">:</span> errors<span class="token punctuation">}</span><span class="token punctuation">)</span>



<span class="token comment" spellcheck="true"># ModelForm</span>
<span class="token keyword">class</span> <span class="token class-name">CarRecordForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>

    carno <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">7</span> <span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'车牌号'</span><span class="token punctuation">,</span> error_messages<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    case <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'违章原因'</span><span class="token punctuation">)</span>
    punish <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                             label<span class="token operator">=</span><span class="token string">'处罚方式'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#required 属性False可以不填</span>

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> CarRecord   <span class="token comment" spellcheck="true"># 指定模型对应的model, 在models.py文件中</span>
        fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'carno'</span><span class="token punctuation">,</span> <span class="token string">'case'</span><span class="token punctuation">,</span> <span class="token string">'punish'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 与数据库模型对应的项目</span>


<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        f <span class="token operator">=</span> CarRecordForm<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 添加初始化字符 initial = {}添加表单初始数据</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> CarRecordForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
        <span class="token keyword">if</span> f<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/search2'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 重定向,跳转到search2</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            errors <span class="token operator">=</span> f<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 所有的错误信息</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'add.html'</span><span class="token punctuation">,</span> context<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'f'</span><span class="token punctuation">:</span> f<span class="token punctuation">,</span> <span class="token string">'errors'</span><span class="token punctuation">:</span> errors<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="./assert/post.png" alt></p>
<p><img src="HTTP请求.png" alt></p>
<p><strong>HTTP无状态协议</strong></p>
<ul>
<li>不能保存之前的结果和做的事情</li>
</ul>
<h4 id="用户跟踪和识别"><a href="#用户跟踪和识别" class="headerlink" title="用户跟踪和识别"></a>用户跟踪和识别</h4><ol>
<li>隐藏域, 隐式表单域, 在提交表单是添加额外的隐藏字段, 表明用户身份</li>
<li>url重写, 在 <code>?</code> 后面  添加额外的键值对, 向服务器提供身份标识, 不能超过2048字节</li>
<li><strong>Cookie</strong> , 放在请求头里面,  服务器用来识别用户身份的标识, 禁用后服务器无法识别,</li>
</ol>
<h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><ul>
<li>主流的验证方式, 在浏览器中的临时文件保存用户的身份标识, 偏好设置, 只能保存4kb内容, 一般只会保存标识性信息<ul>
<li>会话(服务器) session (浏览器保存文件, cookie存储有限, 其他保存在session中)</li>
</ul>
</li>
<li>浏览器 - &gt; 开发者工具 - &gt; Application中 查看</li>
<li>sessionid 会话Id  用户的身份标识, django中有  django_session表中有session<ul>
<li>expire_date失效日期</li>
</ul>
</li>
<li>在每次请求服务器时都会在HTTP协议的请求头中都会携带本网站的Cookie设置</li>
<li>因为HTTP本身是无状态的, 所以需要使用Cookie/隐藏域/Url重写来实现用户跟踪</li>
</ul>
<h5 id="自建项目创建Cookie"><a href="#自建项目创建Cookie" class="headerlink" title="自建项目创建Cookie"></a>自建项目创建Cookie</h5><ul>
<li>记录上次访问时间</li>
</ul>
<ul>
<li>cookie是一个字典</li>
</ul>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    current_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ctime<span class="token punctuation">(</span><span class="token punctuation">)</span>
    last_vist_time <span class="token operator">=</span> request<span class="token punctuation">.</span>COOKIES<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'last_vist_time'</span><span class="token punctuation">,</span> 
                                         current_time<span class="token punctuation">)</span>

    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        ctx <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'show_result'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'last_time'</span><span class="token punctuation">:</span> last_vist_time<span class="token punctuation">}</span>
        response <span class="token operator">=</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'search.html'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
        response<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">'last_vist_time'</span><span class="token punctuation">,</span> current_time<span class="token punctuation">,</span>
                            max_age<span class="token operator">=</span><span class="token number">1209600</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
</code></pre>
<p><img src="cookie.png" alt></p>
<h4 id="对数据进行处理"><a href="#对数据进行处理" class="headerlink" title="对数据进行处理"></a>对数据进行处理</h4><p><img src="清理数据.png" alt></p>
<h4 id="forms-ModelForm额外添加条件验证数据"><a href="#forms-ModelForm额外添加条件验证数据" class="headerlink" title="forms.ModelForm额外添加条件验证数据"></a>forms.ModelForm额外添加条件验证数据</h4><ul>
<li><pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">CarRecordForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>

  carno <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">7</span> <span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'车牌号'</span><span class="token punctuation">,</span> error_messages<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  case <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'违章原因'</span><span class="token punctuation">)</span>
  punish <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'处罚方式'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#required 属性False可以不填</span>

  <span class="token keyword">def</span> <span class="token function">clean_carno</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 验证数据, clean_开头,</span>
                            <span class="token comment" spellcheck="true"># 加对应的字段名字 自动执行下面的验证规则</span>

      _carno <span class="token operator">=</span> self<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">[</span><span class="token string">'carno'</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> _carno <span class="token keyword">in</span> condition<span class="token punctuation">:</span>
          <span class="token comment" spellcheck="true">#写验证条件, 验证通过</span>
          <span class="token keyword">return</span> self<span class="token punctuation">.</span>_carno
      <span class="token keyword">else</span><span class="token punctuation">:</span>
          <span class="token comment" spellcheck="true"># 验证失败, 没通过</span>
          <span class="token keyword">raise</span> forms<span class="token punctuation">.</span>ValidationError<span class="token punctuation">(</span><span class="token string">'错误信息'</span><span class="token punctuation">)</span>

  <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
      model <span class="token operator">=</span> Car
      fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'carno'</span><span class="token punctuation">,</span> <span class="token string">'case'</span><span class="token punctuation">,</span> <span class="token string">'punish'</span><span class="token punctuation">)</span>
</code></pre>
</li>
</ul>
<h3 id="session"><a href="#session" class="headerlink" title="session"></a>session</h3><ul>
<li>服务器端, 与cookie对应(浏览器端)</li>
</ul>
<h4 id="拦截过滤器模式"><a href="#拦截过滤器模式" class="headerlink" title="拦截过滤器模式"></a>拦截过滤器模式</h4><ul>
<li><p>MIDDLEWEAR    -  中间键</p>
<ul>
<li>拦截过滤器, 拦截请求和响应, 附加操作, 在这里统一处理</li>
<li>HTTPresponse,   Httprequest</li>
</ul>
</li>
<li><p>将处理请求代码剥离出来, 最为中间键</p>
</li>
</ul>
<h4 id="session应用"><a href="#session应用" class="headerlink" title="session应用"></a>session应用</h4><ul>
<li>通过request的session属性可以获取到session</li>
<li>session 相当于是服务器端用来保存用户数据的一个字典</li>
<li>session 利用了Cookie保存sessionid 通过sessionid就可以获取用户会话的</li>
<li>如果在浏览器中清除了Cookie那么也就清除了sessionid</li>
<li>再次访问服务器时会重新分配新的sessionid 之前的用户数据将失效</li>
<li>默认情况下Django的session被设定为持久化而不是浏览器续存期会话</li>
<li>通过<code>SESSION_EXPIRE_AT_BROWSER_CLOSE</code> 和<code>SESSION_COOKIE_AGE</code>可以修改默认的模式和参数, 改变session的存在时间</li>
<li>Django中的session是进行了持久化的处理的, 因此需要设定session 的序列化方式, </li>
<li>从1.6版开始 Django默认的序列化方式是<code>JsonSerializer</code></li>
<li>可以通过<code></code>SESSION_SERIALIZER`来设定其他的序列化器<ul>
<li>例如通过<code>PickleSerializer</code></li>
<li><code>SESSION_SERIALIZER = &#39;django.contrib.sessions.serializers.PickleSerializer&#39;</code></li>
</ul>
</li>
</ul>
<p>views.py</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> redirect

<span class="token keyword">from</span> cart<span class="token punctuation">.</span>models <span class="token keyword">import</span> Goods


<span class="token keyword">class</span> <span class="token class-name">CartItem</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> no<span class="token punctuation">,</span> goods<span class="token punctuation">,</span> amount<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>no <span class="token operator">=</span> no
        self<span class="token punctuation">.</span>goods <span class="token operator">=</span> goods
        self<span class="token punctuation">.</span>amount <span class="token operator">=</span> amount

    @property
    <span class="token keyword">def</span> <span class="token function">total</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">return</span> self<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>price <span class="token operator">*</span> self<span class="token punctuation">.</span>amount


<span class="token keyword">class</span> <span class="token class-name">ShoppingCart</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>items <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">add_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> item<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>id <span class="token keyword">in</span> self<span class="token punctuation">.</span>items<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>items<span class="token punctuation">[</span>item<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>amount <span class="token operator">+=</span> item<span class="token punctuation">.</span>amount
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>items<span class="token punctuation">[</span>item<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> item
            self<span class="token punctuation">.</span>num <span class="token operator">+=</span> <span class="token number">1</span>

    @property
    <span class="token keyword">def</span> <span class="token function">total</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        val <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">.</span>items<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            val <span class="token operator">+=</span> item<span class="token punctuation">.</span>total
        <span class="token keyword">return</span> val


<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    goods_list <span class="token operator">=</span> Goods<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'goods.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'goods_list'</span><span class="token punctuation">:</span> goods_list<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">add_to_cart</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    goods <span class="token operator">=</span> Goods<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span>id<span class="token punctuation">)</span>
    cart <span class="token operator">=</span> request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">,</span> ShoppingCart<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    item <span class="token operator">=</span> CartItem<span class="token punctuation">(</span>cart<span class="token punctuation">.</span>num<span class="token punctuation">,</span> goods<span class="token punctuation">)</span>
    cart<span class="token punctuation">.</span>add_item<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    request<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'cart'</span><span class="token punctuation">]</span> <span class="token operator">=</span> cart
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/cart'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">show_cart</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    current_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ctime<span class="token punctuation">(</span><span class="token punctuation">)</span>
    last_vist_time <span class="token operator">=</span> request<span class="token punctuation">.</span>COOKIES<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'last_vist_time'</span><span class="token punctuation">,</span> <span class="token string">'第一次访问'</span><span class="token punctuation">)</span>


    cart <span class="token operator">=</span> request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>
    cart_items <span class="token operator">=</span> cart<span class="token punctuation">.</span>items<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> cart <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    total <span class="token operator">=</span> cart<span class="token punctuation">.</span>total <span class="token keyword">if</span> cart <span class="token keyword">else</span> <span class="token number">0</span>
    ctx <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'cart_items'</span><span class="token punctuation">:</span>cart_items<span class="token punctuation">,</span>
        <span class="token string">'total'</span><span class="token punctuation">:</span> total<span class="token punctuation">,</span>
        <span class="token string">'last_vist_time'</span><span class="token punctuation">:</span> last_vist_time
    <span class="token punctuation">}</span>
    response <span class="token operator">=</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'cart.html'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
    response<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">'last_vist_time'</span><span class="token punctuation">,</span> current_time<span class="token punctuation">)</span>
    <span class="token keyword">return</span> response
</code></pre>

            <!-- / the end of articles -->
        </div>
        <!-- / left section -->
        
        
            <hr/>
            <div id="disqus_thread" style=" margin-top: 15px; margin-bottom: 25px; "></div>
            <script>
                /**
                *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
                /*
                var disqus_config = function () {
                this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                };
                */
                (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');
                s.src = 'https://morgan-hexo-theme.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        

        <!-- Next Post and Prev Post -->
        
        <hr/>
        <div class="next-prev-post-section">
            
                <a href="/2019/04/21/django小结01/" class="styled-border">
                    ←
                    Django-小结
                    
                </a>
            
            
                <a href="/2019/04/21/04django日志/" class="styled-border">
                    
                    Django-日志处理
                    →
                </a>
            
        </div>
        
</div>
<script type="text/javascript">
    let img = document.getElementsByTagName("img");
    for(let i = 0; i < img.length; i++){
        img[i].className += " ts fluid image";
    }
</script>
<!-- / main section -->

<!-- copyright -->
<div class="ts attached secondary segment">
    <div class="ts narrow container">
        <br>
        <div class="ts large center aligned header">
            Powered by Hexo, Theme designs by @hpcslag.
            <div class="smaller sub header">
                Style-Framework Tocas-UI designs by @yamioldmel 
            </div>
        </div>
        <br>
    </div>
</div>
<!-- / copyright -->
<script type="text/javascript">
    
    const slogans = ["Hallo, dit is lanms blog","嗨，這是我的博客!","안녕하세요, 제 블로그입니다.","Hi, This is my blog!","こんにちは、私のブログへようこそ!","مرحبا، مرحبا بك في مدونتي"];
</script>
<script src="/js/script.js"></script>

