<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>深入flask模型的查询 | Lanms Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="05-1-深入flask模型的查询 Auth: 王海飞 Data：2018-05-16 Email：779598160@qq.com github：https://github.com/coco369/knowledge  1. 深入数据库增删改查定义模型，并定义初始化的函数： class Student(db.Model):      s_id = db.Column(db.Integer, p">
<meta name="keywords" content="Flask">
<meta property="og:type" content="article">
<meta property="og:title" content="深入flask模型的查询">
<meta property="og:url" content="http://yoursite.com/2019/04/27/05.1-深入flask模型的查询/index.html">
<meta property="og:site_name" content="Lanms Blog">
<meta property="og:description" content="05-1-深入flask模型的查询 Auth: 王海飞 Data：2018-05-16 Email：779598160@qq.com github：https://github.com/coco369/knowledge  1. 深入数据库增删改查定义模型，并定义初始化的函数： class Student(db.Model):      s_id = db.Column(db.Integer, p">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://github.com/coco369/knowledge/raw/master/flask/images/flask_sqlalchemy_paginate.png">
<meta property="og:updated_time" content="2019-04-27T07:32:49.362Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入flask模型的查询">
<meta name="twitter:description" content="05-1-深入flask模型的查询 Auth: 王海飞 Data：2018-05-16 Email：779598160@qq.com github：https://github.com/coco369/knowledge  1. 深入数据库增删改查定义模型，并定义初始化的函数： class Student(db.Model):      s_id = db.Column(db.Integer, p">
<meta name="twitter:image" content="https://github.com/coco369/knowledge/raw/master/flask/images/flask_sqlalchemy_paginate.png">
  
    <link rel="alternate" href="/atom.xml" title="Lanms Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  <link rel="stylesheet" href="/css/tocas.css">
  <link rel="stylesheet" href="/css/animate.css">
  <link rel="stylesheet" href="/css/style.css">
  <style type="text/css">
    a.title-link:hover{
        color: #34b2db !important;
    }

    a.title-link:active{
        color: #2075c1 !important;
    }

    #menu-color-id{
        background : #f7f7f7;
    }

    #menu-color-id a{
        color: #5a5a5a;
    }
  </style>
  <script src="/js/tocas.js"></script>
  

<link rel="stylesheet" href="/css/prism.css" type="text/css"></head></html>

<body>
<!-- navigation -->

<div class="ts fluid basic link big menu" id="menu-color-id">

    <!-- ejs : align to post page or index page -->
        
            <div class="ts very narrow container">
        

        
            <a class="item" href="/">Home</a>
        
            <a class="item" href="/archives">Archives</a>
        
    </div>
</div>
<!-- the end of navigation -->

<!-- big bang title -->
<div class="ts padded horizontally fitted fluid slate" style="background-color: #f7f7f7;">
    <!-- ejs : align to post page or index page -->
    
        <div class="ts very narrow container">
    
        <!-- Title -->
        <h1 class="ts eleven wide column header be-center-h1">
            <span style="color: #404040;" id="big-title">Lanms Blog</span>
            <div class="sub header" id="slogan-bar" style=" margin-top: 15px; color: #404040;"></div>
        </h1>
        <!-- the end of title -->
    </div>
</div>
<!-- the end of big bang title -->
</body>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">

<!-- main section -->
<div class="ts text container">
        <!-- left section -->
        <div class="column" style=" padding: 35px; ">
            <!-- Articles -->
                
                <h1 class="ts header">
                    <span style="color: #333;">深入flask模型的查询</span>
                    <div class="sub header" style="color: #808080;">Publish: 2019/3/27 
                     &nbsp;&nbsp;
                        <ul class="unstyled radius-tag -list"><li class="unstyled radius-tag -list-item"><a class="unstyled radius-tag -list-link" href="/tags/Flask/">Flask</a></li></ul>
                    
                    </div>
                </h1>

                <h1 id="05-1-深入flask模型的查询"><a href="#05-1-深入flask模型的查询" class="headerlink" title="05-1-深入flask模型的查询"></a>05-1-深入flask模型的查询</h1><blockquote>
<p>Auth: 王海飞</p>
<p>Data：2018-05-16</p>
<p>Email：<a href="mailto:779598160@qq.com" target="_blank" rel="noopener">779598160@qq.com</a></p>
<p>github：<a href="https://github.com/coco369/knowledge" target="_blank" rel="noopener">https://github.com/coco369/knowledge</a></p>
</blockquote>
<h3 id="1-深入数据库增删改查"><a href="#1-深入数据库增删改查" class="headerlink" title="1. 深入数据库增删改查"></a>1. 深入数据库增删改查</h3><p>定义模型，并定义初始化的函数：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>

    s_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    s_name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    s_age <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    __tablename__ <span class="token operator">=</span> <span class="token string">"student"</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>s_name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>s_age <span class="token operator">=</span> age
</code></pre>
<h4 id="1-1-增–批量增加"><a href="#1-1-增–批量增加" class="headerlink" title="1.1 增–批量增加"></a>1.1 增–批量增加</h4><p>第一种方式：</p>
<pre class=" language-python"><code class="language-python">@blue<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/createstus/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    stus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 实例化Student的对象</span>
        s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># 对象的属性赋值</span>
        s<span class="token punctuation">.</span>s_name <span class="token operator">=</span> <span class="token string">'张三%s'</span> <span class="token operator">%</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>s_age <span class="token operator">=</span> <span class="token string">'%d'</span> <span class="token operator">%</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        stus<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 添加需要创建的数据</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span>stus<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 提交事务到数据库</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'创建成功'</span>
</code></pre>
<p>注：在创建单条数据的时候使用db.session.add()，在创建多条数据的时候使用db.session.add_all()</p>
<p>第二种方式：</p>
<pre class=" language-python"><code class="language-python">@blue<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/createstus/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    stus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 使用类的初始化去创建Student对象</span>
        s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'张三%s'</span> <span class="token operator">%</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">'%d'</span> <span class="token operator">%</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        stus<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span>stus<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'创建成功'</span>
</code></pre>
<h4 id="1-2-查–使用运算符"><a href="#1-2-查–使用运算符" class="headerlink" title="1.2 查–使用运算符"></a>1.2 查–使用运算符</h4><p>获取查询集</p>
<pre class=" language-python"><code class="language-python">filter<span class="token punctuation">(</span>类名<span class="token punctuation">.</span>属性名<span class="token punctuation">.</span>运算符<span class="token punctuation">(</span>‘xxx’<span class="token punctuation">)</span><span class="token punctuation">)</span>

filter<span class="token punctuation">(</span>类名<span class="token punctuation">.</span>属性 数学运算符  值<span class="token punctuation">)</span>
</code></pre>
<p>运算符：</p>
<pre class=" language-python"><code class="language-python">contains： 包含
startswith：以什么开始
endswith：以什么结束
in_：在范围内
like：模糊
__gt__<span class="token punctuation">:</span> 大于
__ge__：大于等于
__lt__：小于
__le__：小于等于
</code></pre>
<p>筛选：</p>
<pre class=" language-python"><code class="language-python">offset<span class="token punctuation">(</span><span class="token punctuation">)</span>

limit<span class="token punctuation">(</span><span class="token punctuation">)</span>

order_by<span class="token punctuation">(</span><span class="token punctuation">)</span>

get<span class="token punctuation">(</span><span class="token punctuation">)</span>

first<span class="token punctuation">(</span><span class="token punctuation">)</span>

paginate<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>逻辑运算：</p>
<pre class=" language-python"><code class="language-python">与
    and_
    filter<span class="token punctuation">(</span>and_<span class="token punctuation">(</span>条件<span class="token punctuation">)</span><span class="token punctuation">,</span>条件…<span class="token punctuation">)</span>

或
    or_
    filter<span class="token punctuation">(</span>or_<span class="token punctuation">(</span>条件<span class="token punctuation">)</span><span class="token punctuation">,</span>条件…<span class="token punctuation">)</span>

非
    not_
    filter<span class="token punctuation">(</span>not_<span class="token punctuation">(</span>条件<span class="token punctuation">)</span><span class="token punctuation">,</span>条件…<span class="token punctuation">)</span>
</code></pre>
<p>例子1：</p>
<ol>
<li><p>查询学生的id为3，4，5，6，16的的学生信息，使用<strong>in_逻辑运算</strong></p>
<pre class=" language-python"><code class="language-python"> @blue<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/getstubyids/'</span><span class="token punctuation">)</span>
 <span class="token keyword">def</span> <span class="token function">get_stu_by_ids</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

     students <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Student<span class="token punctuation">.</span>s_id<span class="token punctuation">.</span>in_<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'StudentList.html'</span><span class="token punctuation">,</span> students<span class="token operator">=</span>students<span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>查询学生的年龄小于18岁的学生的信息</p>
<pre class=" language-python"><code class="language-python"> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Student<span class="token punctuation">.</span>s_age <span class="token operator">&lt;</span> <span class="token number">18</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>查询学生的年龄小于18岁的学生的信息，<strong><strong>lt</strong>小于</strong></p>
<pre class=" language-python"><code class="language-python"> students <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Student<span class="token punctuation">.</span>s_age<span class="token punctuation">.</span>__lt__<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>查询学生的年龄小于等于18岁的学生的信息，<strong><strong>le</strong>小于等于</strong></p>
<pre class=" language-python"><code class="language-python"> students <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Student<span class="token punctuation">.</span>s_age<span class="token punctuation">.</span>__le__<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>查询学生的姓名以什么开始或者以什么结尾的学生的信息<strong>startswith和endswith</strong></p>
<pre class=" language-python"><code class="language-python"> students <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Student<span class="token punctuation">.</span>s_name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'张'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 students <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Student<span class="token punctuation">.</span>s_name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>查询id=4的学生的信息</p>
<pre class=" language-python"><code class="language-python"> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
 获取的结果是学生的对象
</code></pre>
</li>
<li><p>模糊搜索like</p>
<pre class=" language-python"><code class="language-python"> <span class="token operator">%</span>：代表一个或者多个
 _：代表一个

 Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Student<span class="token punctuation">.</span>s_name<span class="token punctuation">.</span>like<span class="token punctuation">(</span><span class="token string">'%张%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
</code></pre>
</li>
<li><p>分页，查询第二页的数据4条</p>
<pre class=" language-python"><code class="language-python"> 第一个参数是那一页，第二个参数是一页的条数，第三个参数是是否输出错误信息
 students <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>paginate<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items
</code></pre>
</li>
</ol>
<p>例子2：</p>
<p>跳过offset几个信息，截取limit结果的几个值</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 按照id降序排列</span>
stus <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-s_id'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 按照id降序获取三个</span>
stus <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-s_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 获取年龄最大的一个</span>
stus <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-s_age'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 跳过3个数据，查询5个信息</span>
stus <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-s_age'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>offset<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 跳过3个数据</span>
stus <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-s_age'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>offset<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 获取id等于24的学生</span>
stus <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Student<span class="token punctuation">.</span>s_id<span class="token operator">==</span><span class="token number">24</span><span class="token punctuation">)</span>
stus <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span>
</code></pre>
<p>例子3：</p>
<ol>
<li><p>查询</p>
<p>from sqlalchemy import and_, or_, not_</p>
<p><strong>查询多个条件</strong></p>
<p>stus = Student.query.filter(Student.s_age==18, Student.s_name==’雅典娜’)</p>
<p><strong>and_ 并且条件</strong></p>
<p>stus = Student.query.filter(and_(Student.s_age==18, Student.s_name==’雅典娜’))</p>
<p><strong>or_ 或者条件</strong></p>
<p>stus = Student.query.filter(or_(Student.s_age==18, Student.s_name==’火神’))</p>
<p><strong>not_ 非</strong></p>
<p>stus = Student.query.filter(not_(Student.s_age==18), Student.s_name==’火神’)</p>
</li>
</ol>
<p>例子4：</p>
<p><strong>分页：</strong></p>
<p><a href="https://github.com/coco369/knowledge/blob/master/flask/images/flask_sqlalchemy_paginate.png" target="_blank" rel="noopener"><img src="https://github.com/coco369/knowledge/raw/master/flask/images/flask_sqlalchemy_paginate.png" alt="图"></a></p>
<p>后端数据处理：</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 查询第几页的数据    </span>
page <span class="token operator">=</span> int<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 每一页的条数多少，默认为10条</span>
per_page <span class="token operator">=</span> int<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'per_page'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 查询当前第几个的多少条数据</span>
paginate <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-s_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>paginate<span class="token punctuation">(</span>page<span class="token punctuation">,</span> per_page<span class="token punctuation">,</span> error_out<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

stus <span class="token operator">=</span> paginate<span class="token punctuation">.</span>items
</code></pre>
<p>前端数据展示：</p>
<pre class=" language-python"><code class="language-python"><span class="token operator">&lt;</span>h2<span class="token operator">></span>学生信息<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> stu <span class="token keyword">in</span> stus <span class="token operator">%</span><span class="token punctuation">}</span>
    id：<span class="token punctuation">{</span><span class="token punctuation">{</span> stu<span class="token punctuation">.</span>s_id <span class="token punctuation">}</span><span class="token punctuation">}</span>
    姓名：<span class="token punctuation">{</span><span class="token punctuation">{</span> stu<span class="token punctuation">.</span>s_name <span class="token punctuation">}</span><span class="token punctuation">}</span>
    年龄：<span class="token punctuation">{</span><span class="token punctuation">{</span> stu<span class="token punctuation">.</span>s_age <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>br<span class="token operator">></span>
<span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span>br<span class="token operator">></span>
总页数<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> paginate<span class="token punctuation">.</span>pages <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span>br<span class="token operator">></span>
一共<span class="token punctuation">{</span><span class="token punctuation">{</span> paginate<span class="token punctuation">.</span>total <span class="token punctuation">}</span><span class="token punctuation">}</span>条数据
<span class="token operator">&lt;</span>br<span class="token operator">></span>
当前页数：<span class="token punctuation">{</span><span class="token punctuation">{</span> paginate<span class="token punctuation">.</span>page <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span>br<span class="token operator">></span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> paginate<span class="token punctuation">.</span>has_prev <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/stupage/?page={{ paginate.prev_num }}"</span><span class="token operator">></span>上一页<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>：<span class="token punctuation">{</span><span class="token punctuation">{</span> paginate<span class="token punctuation">.</span>prev_num <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> paginate<span class="token punctuation">.</span>has_next <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/stupage/?page={{ paginate.next_num }}"</span><span class="token operator">></span>下一页<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>：<span class="token punctuation">{</span><span class="token punctuation">{</span> paginate<span class="token punctuation">.</span>next_num <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span>br<span class="token operator">></span>

<span class="token operator">&lt;</span>br<span class="token operator">></span>
页码：<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> i <span class="token keyword">in</span>  paginate<span class="token punctuation">.</span>iter_pages<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/stupage/?page={{ i }}"</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">{</span> i <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>
    <span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre>
<h3 id="2-关联关系"><a href="#2-关联关系" class="headerlink" title="2. 关联关系"></a>2. 关联关系</h3><h4 id="2-1-一对多建立模型"><a href="#2-1-一对多建立模型" class="headerlink" title="2.1 一对多建立模型"></a>2.1 一对多建立模型</h4><p>学生模型：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>

    s_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    s_name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    s_age <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">)</span>
    s_g <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'grade.g_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    __tablename__ <span class="token operator">=</span> <span class="token string">'student'</span>
</code></pre>
<p>班级模型：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>

    g_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    g_name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    g_desc <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    g_time <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Date<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>
    students <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">'Student'</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">'stu'</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    __tablename__ <span class="token operator">=</span> <span class="token string">'grade'</span>
</code></pre>
<p>官网解释有如下几个lazy的参数：</p>
<p>lazy 决定了 SQLAlchemy 什么时候从数据库中加载数据:，有如下四个值:</p>
<p><strong>select</strong>/True: (which is the default) means that SQLAlchemy will load the data as necessary in one go using a standard select statement.</p>
<p><strong>joined</strong>/False: tells SQLAlchemy to load the relationship in the same query as the parent using a JOIN statement.</p>
<p><strong>subquery</strong>: works like ‘joined’ but instead SQLAlchemy will use a subquery.</p>
<p><strong>dynamic</strong>: is special and useful if you have many items. Instead of loading the items SQLAlchemy will return another query object which you can further refine before loading the items. This is usually what you want if you expect more than a handful of items for this relationship</p>
<pre class=" language-python"><code class="language-python">select就是访问到属性的时候，就会全部加载该属性的数据。

joined则是在对关联的两个表进行join操作，从而获取到所有相关的对象。

dynamic则不一样，在访问属性的时候，并没有在内存中加载数据，而是返回一个query对象<span class="token punctuation">,</span> 需要执行相应方法才可以获取对象，
</code></pre>
<h4 id="2-2"><a href="#2-2" class="headerlink" title="2.2"></a>2.2</h4><ol>
<li><p>通过班级查询学生信息</p>
<pre class=" language-python"><code class="language-python"> @grade<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/selectstubygrade/&lt;int:id>/'</span><span class="token punctuation">)</span>

 <span class="token keyword">def</span> <span class="token function">select_stu_by_grade</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">:</span>
     grade <span class="token operator">=</span> Grade<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span>id<span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true"># 通过班级对象.定义的relationship变量去获取学生的信息</span>
     stus <span class="token operator">=</span> grade<span class="token punctuation">.</span>students

     <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'grade_student.html'</span><span class="token punctuation">,</span>
                            stus<span class="token operator">=</span>stus<span class="token punctuation">,</span>
                            grade<span class="token operator">=</span>grade<span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>通过学生信息查询班级信息</p>
<pre class=" language-python"><code class="language-python"> @stu<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/selectgradebystu/&lt;int:id>/'</span><span class="token punctuation">)</span>

 <span class="token keyword">def</span> <span class="token function">select_grade_by_stu</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">:</span>

     stu <span class="token operator">=</span> Student<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span>id<span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true"># 通过学生对象.定义的backref参数去获取班级的信息</span>
     grade <span class="token operator">=</span> stu<span class="token punctuation">.</span>stu

     <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'student_grade.html'</span><span class="token punctuation">,</span>
                            grade<span class="token operator">=</span>grade<span class="token punctuation">,</span>
                            stu<span class="token operator">=</span>stu<span class="token punctuation">)</span>
</code></pre>
</li>
</ol>
<p>注意：表的外键由db.ForeignKey指定，传入的参数是表的字段。db.relations它声明的属性不作为表字段，第一个参数是关联类的名字，backref是一个反向身份的代理,相当于在Student类中添加了stu的属性。例如，有Grade实例dept和Student实例stu。dept.students.count()将会返回学院学生人数;stu.stu.first()将会返回学生的学院信息的Grade类实例。一般来讲db.relationship()会放在一这一边。</p>
<h3 id="3-数据库迁移"><a href="#3-数据库迁移" class="headerlink" title="3. 数据库迁移"></a>3. 数据库迁移</h3><p>在django中继承了makemigrations，可以通过migrate操作去更新数据库，修改我们定义的models，然后在将模型映射到数据库中。</p>
<p>在flask中也有migrate操作，它能跟踪模型的变化，并将变化映射到数据库中</p>
<h4 id="2-1-安装migrate"><a href="#2-1-安装migrate" class="headerlink" title="2.1 安装migrate"></a>2.1 安装migrate</h4><pre class=" language-python"><code class="language-python">pip install flask<span class="token operator">-</span>migrate
</code></pre>
<h4 id="2-2-配置使用migrate"><a href="#2-2-配置使用migrate" class="headerlink" title="2.2 配置使用migrate"></a>2.2 配置使用migrate</h4><h5 id="2-2-1-初始化，使用app和db进行migrate对象的初始化"><a href="#2-2-1-初始化，使用app和db进行migrate对象的初始化" class="headerlink" title="2.2.1 初始化，使用app和db进行migrate对象的初始化"></a>2.2.1 初始化，使用app和db进行migrate对象的初始化</h5><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate

<span class="token comment" spellcheck="true">#绑定app和数据库</span>
Migrate<span class="token punctuation">(</span>app<span class="token operator">=</span>app<span class="token punctuation">,</span> db<span class="token operator">=</span>db<span class="token punctuation">)</span>
</code></pre>
<h5 id="2-2-2-安装了flask-script的话，可以在Manager-对象上添加迁移指令"><a href="#2-2-2-安装了flask-script的话，可以在Manager-对象上添加迁移指令" class="headerlink" title="2.2.2 安装了flask-script的话，可以在Manager()对象上添加迁移指令"></a>2.2.2 安装了flask-script的话，可以在Manager()对象上添加迁移指令</h5><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate<span class="token punctuation">,</span> MigrateCommand

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

manage <span class="token operator">=</span> Manager<span class="token punctuation">(</span>app<span class="token operator">=</span>app<span class="token punctuation">)</span>

manage<span class="token punctuation">.</span>add_command<span class="token punctuation">(</span><span class="token string">'db'</span><span class="token punctuation">,</span> MigrateCommand<span class="token punctuation">)</span>
</code></pre>
<p>操作：</p>
<pre><code>python manage.py db init  初始化出migrations的文件，只调用一次

python manage.py db migrate  生成迁移文件

python manage.py db upgrade 执行迁移文件中的升级

python manage.py db downgrade 执行迁移文件中的降级

python manage.py db --help 帮助文档
</code></pre>
            <!-- / the end of articles -->
        </div>
        <!-- / left section -->
        
        
            <hr/>
            <div id="disqus_thread" style=" margin-top: 15px; margin-bottom: 25px; "></div>
            <script>
                /**
                *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
                /*
                var disqus_config = function () {
                this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                };
                */
                (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');
                s.src = 'https://morgan-hexo-theme.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        

        <!-- Next Post and Prev Post -->
        
        <hr/>
        <div class="next-prev-post-section">
            
                <a href="/2019/04/27/05-数据查询和模型迁移migrate/" class="styled-border">
                    ←
                    模型的一对多查询和数据迁移
                    
                </a>
            
            
                <a href="/2019/04/27/05.2-Flask查询数据库-blog摘录/" class="styled-border">
                    
                    Flask操作数据库
                    →
                </a>
            
        </div>
        
</div>
<script type="text/javascript">
    let img = document.getElementsByTagName("img");
    for(let i = 0; i < img.length; i++){
        img[i].className += " ts fluid image";
    }
</script>
<!-- / main section -->

<!-- copyright -->
<div class="ts attached secondary segment">
    <div class="ts narrow container">
        <br>
        <div class="ts large center aligned header">
            Powered by Hexo, Theme designs by @hpcslag.
            <div class="smaller sub header">
                Style-Framework Tocas-UI designs by @yamioldmel 
            </div>
        </div>
        <br>
    </div>
</div>
<!-- / copyright -->
<script type="text/javascript">
    
    const slogans = ["Hallo, dit is lanms blog","嗨，這是我的博客!","안녕하세요, 제 블로그입니다.","Hi, This is my blog!","こんにちは、私のブログへようこそ!","مرحبا، مرحبا بك في مدونتي"];
</script>
<script src="/js/script.js"></script>

